# AI 协作规则（AI Operating Rules）

> 本文件用于统一 AI 与开发者之间的协作方式，是跨项目、跨文档通用的工作协议。  
> 它不描述具体产品功能，而是指导如何在项目中使用 `spec.md`、`style.md`、`content.md`、`tech.md`、`tasks.md` 等协作文档。

---

## 0. 优先级与裁决顺序

- 文档优先级（从高到低）：

  1. `spec.md`（需求 / 行为逻辑）
  2. `rules.md`（本文件，协作规则与流程约束）
  3. `content.md`（网站信息架构与页面蓝图）
  4. `style.md`（视觉样式与交互表现）
  5. `tech.md`（技术栈与基础设施选型）
  6. `tasks.md`（任务拆分与执行节奏）
  7. 其他推断或上下文（聊天记录、历史习惯等）

- 若文档内容发生冲突：
  - 一律以 `spec.md > rules.md > content.md > style.md > tech.md > tasks.md > 其他推断` 为裁决顺序。
  - AI 必须主动指出冲突点并请求决策，而不是自行选其中一个版本执行。

---

## 1. 全局工作流程（适用于所有任务）

执行任何非琐碎任务前，AI 必须遵循以下步骤：

1. **识别相关文档**

   - 判断当前任务是否涉及：
     - 功能需求与行为逻辑 → 查阅 `spec.md`
     - 视觉样式与交互表现 → 查阅 `style.md`
     - 网站信息架构与页面蓝图（导航、页面类型、内容模块）→ 查阅 `content.md`
     - 技术栈与基础设施（框架、部署、环境变量等）→ 查阅 `tech.md`
     - 执行计划与任务拆分 → 查阅 `tasks.md`
   - 若文档缺失或明显不完整，应先提示并建议补全。

2. **确认目标与边界**

   - 用简洁的要点总结：本次任务要达成什么、不做什么。
   - 将自己的理解反馈给用户，等待确认或修正后再继续。

3. **拆解执行步骤**

   - 以 3–7 个步骤列出执行计划（可以对应 `tasks.md` 的父任务 / 子任务结构）。
   - 标明每步的大致输入、输出和依赖前置条件。

4. **执行并生成产物**

   - 按计划逐步实现代码或文档，而不是一次性给出最终结果。
   - 对于已有 `tasks.md` 的场景，应优先遵循其中的子任务顺序。

5. **自检与汇总**
   - 对照 `spec.md` / `style.md` / `content.md` / `tech.md` / `tasks.md` 自行检查：
     - 是否遗漏关键需求、页面结构、样式约束或技术边界条件？
     - 输出是否可直接执行 / 使用（不是草稿碎片）？
     - 相关文档是否需要同步更新（如示例代码路径、配置说明、环境变量清单等）？
   - 自检通过后再给出终稿回答。

---

## 2. 提问与信息缺失原则

- **生成前先提问：**

  - 若任务描述中存在关键不确定因素（行为逻辑、边界条件、重要配置），必须先提问澄清；
  - 对于功能需求、交互逻辑、视觉样式、任务边界等关键点，如文档未明确说明，必须通过与用户沟通补全，而不是自行假设。

- **信息缺失不得臆断：**
  - 对于会明显影响架构或用户体验的决策，AI 不得凭空捏造事实（例如：自行设定业务流程、接口协议、品牌定位）；
  - 如确需假设，必须：
    1. 明确标注为「假设」；
    2. 说明该假设对实现的影响；
    3. 建议用户确认或在后续版本中修正。

---

## 3. 回答格式规范（Summary / Reasoning / Output / Next Step）

在重要任务的回复中（包括功能设计、任务拆分、样式体系设计等），AI 的回答应尽量采用如下结构化格式：

1. **Summary（总结 / 结论）**

   - 1–3 条要点，概括本次回答的核心结论或决策；
   - 回答「这次我到底帮你完成 / 决定了什么」。

2. **Reasoning（理由 / 取舍说明）**

   - 对涉及选择、权衡或假设的部分，简要说明理由；
   - 不需要展开冗长推理链，只需列出关键判断依据（如：与 spec 一致、与现有样式体系兼容、减少未来维护成本等）。

3. **Output（产物）**

   - 给出可直接使用的结果：代码、配置、Markdown 文档片段等；
   - 若修改了现有文件，说明修改了哪些文件、哪些主要位置（不必贴出所有上下文）。

4. **Next Step（下一步）**
   - 指出 AI 下一步可以做什么，或用户需要提供什么输入；
   - 在有 `tasks.md` 的项目中，应明确下一步对应哪个任务 / 子任务编号。

> 若信息不足以安全决策 → **不要** 用臆测填满上述四项，而是先进入「提问澄清」模式，补齐关键信息后再输出结构化结果。

---

## 4. 任务列表与执行节奏（与 tasks.md 的协作）

当项目存在 `tasks.md` 时，AI 在执行任务时必须遵循以下约定（与 `generate-tasks.md` 保持一致）：

1. **一次只做一个子任务**

   - 不得在未与用户确认的情况下连续完成多个子任务；
   - 完成一个子任务后，应先更新 `tasks.md` 并暂停，等待用户确认再继续。

2. **完成协议**

   - 完成某个子任务时，立即将对应条目的 `- [ ]` 改为 `- [x]`；
   - 当某个父任务下所有子任务均为 `[x]` 时，同时将该父任务标记为 `- [x]`。

3. **任务列表维护**

   - 在执行过程中，如发现新的必要任务，应补充到 `tasks.md` 中；
   - 保持 `Relevant Files` 部分与实际修改的文件同步，并为每个文件写明一句用途说明。

4. **开始前检查**
   - 在开始工作前，先阅读 `tasks.md`，确认当前「下一个要做的子任务」是哪一条，并与用户对齐。

---

## 5. AI 必须主动执行的行为

在任何项目中，AI 应当始终主动做以下事情，而不是被动等待提问：

- **检查依赖文档是否需要同步更新：**

  - 修改功能行为 → 检查 `spec.md` 是否需要同步；
  - 修改 UI 样式或组件 → 检查 `style.md` 是否需要同步；
  - 修改任务边界或拆解方式 → 检查 `tasks.md` 是否需要同步。

- **验证输出可用性：**

  - 代码：至少在逻辑上可运行（无明显语法错误、路径错误等），必要时说明依赖的运行环境；
  - 文档：结构清晰、可直接作为团队参考，而不是散乱笔记。

- **发现逻辑空洞时提醒：**

  - 若需求存在明显缺失、矛盾或无法闭环，必须显式提醒用户，而不是「跳过这部分」继续往下写。

- **保持风格与系统一致性：**
  - 组件命名、间距体系、排版，应与既有 `style.md` 和代码中的实践一致；
  - 避免在未说明的情况下突然引入新的设计体系或命名方式。

---

## 6. 常驻指令（行为准则）

AI 在任何回答中，都应遵守以下常驻指令：

- **避免幻想式产出：**

  - 不构造用户未提供、文档未说明的事实；
  - 必须区分「事实」「假设」「建议」，并用文字标清。

- **保持风格一致：**

  - 响应式策略、组件命名方式、间距体系、Typography 等，应与现有文档和代码保持一致；
  - 对确需改变的模式，应先提出「重构建议」，经确认后再执行。

- **优先提出更优建议，而不是机械执行：**
  - 在不违背 `spec.md` 的前提下，如发现明显更优解（更易维护、更安全、更符合用户习惯），可主动提出，并说明利弊；
  - 若用户明确要求「严格按现有方案执行」，则以后者为准。

---

## 7. 提交代码与开发日志（本仓库约定）

> 以下约定可以作为本仓库内 AI 与开发者协作时的默认规则；在其他项目中，可按需复用或调整。

### 7.1 提交代码（Git 提交规范）

当用户明确要求执行 Git 提交时，AI 应遵循：

- **只提交本次改动涉及的文件**，避免将无关改动混入同一次提交；
- 提交信息使用 **中文**，并遵循 Angular 提交信息规范：
  - 常用 `type`：`feat`（新功能）、`fix`（修复）、`docs`（文档）、`refactor`（重构）、`chore`（杂项）等；
  - 示例：`docs: 新增 AI 协作规则并抽离文档模板职责`。
- 在提交前，尽量：
  - 确认文件已保存且无明显语法错误；
  - 简要检查是否有遗漏的文件未加入提交。

**触发规则：**

- 只有当用户明确发出「commit」指令（例如：“请帮我 commit” 或 “写 commit”）时，AI 才能执行 `git add` / `git commit` 相关操作；
- 在没有这类指令的情况下，**不要主动提交代码**，即使工作已经完成；
- 推送到远端（如 GitHub）仅在用户明确使用诸如「commit sync」这类指令时才执行（例如运行 `git push`），否则默认不推送。

> 若当前环境不允许执行 Git 命令，AI 应说明「提交规范」但不强行模拟提交。

### 7.2 开发者日记（docs/dev-log.md）

开发者日记用于记录「重要且可追踪的项目变更」，要求结构化、易读、不冗长。

- 极简大纲
  为了避免多轮对话导致 AI 写错日志内容，在写入 dev-log.md 之前，AI 必须先输出一个极简大纲供用户确认。

  - 仅列出本次需要记录的项目（1–3 个 bullet）
  - 每个 bullet 不超过 8–12 字
  - 不写技术细节、不写原因、不写实现方式
  - 类似于以下内容即可：
    - 新增 COPY 模式
    - 修复 Search Mode 默认值
    - 更新 tasks.md 编号
      用户确认后再写正式日志。若用户明确说“不需要大纲”，AI 才能跳过此步骤。

- 哪些内容应该记录到 dev-log.md
  仅在 `docs/dev-log.md` 中记录以下类型的变更：

  - Bug 修复（Fix）
  - 新增功能（Feature）
  - 功能或性能优化（Improve）（如与新功能紧密相关，也可以直接归类到 Feature）
  - UI 调整 (UI)
  - 面向用户的内容更新（Content），例如 homepage 方案、扩展详情页文案、帮助/FAQ 等对外说明内容
  - 结构性重构（Refactor）

  不记录：

  - 拼写修正
  - 小幅 UI 调整（如 padding, margin unless important）
  - 内容文案微调（如少量字词替换、错别字修正）
  - 仅涉及内部文档排版、编号或段落结构的小调整，且未引入新的功能或行为变更

- 记录格式：

  - 文件中按日期倒序排列；
  - 每天使用标题：`## YYYY-MM-DD 开发日志`；
  - 当天日志按分类小节组织，如：
    - `### Fix`
    - `### Feature`
    - `### Improve`
    - `### UI`
    - `### Content`
    - `### Refactor`
    - 无该分类改动则省略小节。
  - 每条日记最多保持 3–6 行：
    - 改动目的（最重要）
    - 涉及文件
    - 解决/实现的内容
    - 简要说明如何处理
    - 若有：下一步动作
      说明：原因、技术细节在必要时再写，不强制。

- Lessons Learned 区块
  如果出现「可复用的经验」，AI 应写到文件底部的 Lessons Learned 区块：

  - 一条一句话
  - 不按日期
  - 用 bullet 列出
    此区块作为长期积累的经验库。

- 触发与写作流程

  - 用户明确说"记录到 dev log"或"写 log"
  - 或者完成了重要功能/修复后，AI 主动询问："要记录到 dev log 吗？"
  - 写入原则：
    - 只追加，不修改历史内容。
    - 永远写在文件最前面对应日期下。
    - 如果当天已有日志，追加到当天对应分类下
    - 如果当天还没有日志，新建日期标题
  - 写入步骤：
    - AI 输出极简大纲（1–3 bullet）
    - 用户确认
    - AI 根据大纲生成正式日志并写入 dev-log.md
  - 若用户只要「摘要」，AI 只输出摘要，不写入文件。

---

### 7.3 本地完工提示（必须）

- 在本地完成一组任务或一个阶段性目标后，在终端运行以下命令：

  ```bash
  powershell -c "(New-Object Media.SoundPlayer 'C:\\Windows\\Media\\tada.wav').PlaySync()"
  ```

---

## 8. 添加新功能流程

> 本章节规范「如何向项目中加入一个新功能」，用于指导 AI 和用户的协作流程，确保新增功能在文档、任务和开发日志中保持一致且可追踪。

### 8.1 流程总览（必须遵循的三步法）

新增功能必须经过以下三个阶段：

1. **讨论阶段：** 确认功能范围、要解决的问题、可能的风险与边界。  
2. **文档阶段：** 在规格文档中更新/补充该功能的定义（`docs/spec.md` / `docs/style.md` / `docs/tech.md` / `docs/content.md`，按需选择）。  
3. **计划与记录阶段：** 在 `docs/tasks.md` 中加入对应任务，并在 `docs/dev-log.md` 中记录本次变更。  

文档更新的角色分工（新增功能时应逐一检查是否需要更新）：  

- `docs/spec.md`：**必查**，新增或调整功能逻辑、交互流程、状态与边界；  
- `docs/style.md`：当新增/修改 UI 组件、样式模式或交互表现时更新；  
- `docs/content.md`：当 `content.md` 已从大纲（outline）升级为完整蓝图时，若新增/调整对外页面（例如 Homepage 区块、FAQ 项、导航入口）或 SEO 结构，则需要同步更新；若当前 `content.md` 仍处于大纲阶段，可暂不强制在每次新增功能时修改，仅在准备正式搭建网站前集中补齐；  
- `docs/tech.md`：当引入新技术依赖、新权限或重要基础设施变更时更新；  
- `docs/tasks.md`：将已确认的功能与技术方案拆分为可执行的开发任务；  
- `docs/dev-log.md`：记录本次变更的背景、修改内容与原因。  

> 说明：仅在「新增功能确实影响到该文档职责范围」时才更新对应文档；若某文档与本次功能无直接关系，可以保持不变，无需为了形式完整而强行修改。  

约束：

- AI 不能跳步，也不能在未确认的情况下直接写入任何文档文件；  
- 对 `spec.md` / `style.md` / `tech.md` / `tasks.md` / `dev-log.md` 的修改，必须在用户明确同意后执行。

---

### 8.2 第一步：功能讨论（必需）

当用户提出类似需求时（例如：「我想添加一个新功能，内容是……」），AI 必须先完成功能讨论，而不是直接写文档或代码。

AI 需要执行：

- **提取功能核心要点**：用 1–3 条 bullet 总结「这个功能大概要做什么」。
- **列出待确认问题**：提出 2–5 个关键问题（范围、边界、交互、数据、技术约束等），用编号 + 选项的形式方便用户回答。
- **指出潜在风险或冲突（可选）**：如发现与现有 `spec.md` / `style.md` 有明显冲突，简要指出。
- 明确说明：当前阶段**不写实现细节、不写代码、不直接改文档**，等待用户确认或补充信息后再进入下一步。

只有当用户确认「功能方向没问题，可以进入文档阶段」时，才能进入 8.3。

---

### 8.3 第二步：更新规格文档（spec / style / tech）

当用户明确提出类似指令（如：「好的，请把这个功能加入 spec（或 style / tech）」）时，AI 才能修改规格文档。

AI 必须：

- **判断影响范围：** 功能会影响到哪些文档：  
  - `docs/spec.md`：功能逻辑、交互行为、状态变化；  
  - `docs/style.md`：UI 风格、组件样式、交互表现；  
  - `docs/tech.md`：技术方案、安全限制、依赖变更；  
  - `docs/content.md`：若新功能会影响到对外网站的页面结构、文案蓝图或 SEO 策略（例如新增页面、入口、FAQ 项），需在内容蓝图中补充对应说明。  
- **术语与 Glossary：** 若新功能引入了新的概念或命名（例如新模式、新开关、新页面类型），应同时在 `spec.md` 中的 Glossary（术语表）新增或更新对应条目，并在后续文档与代码中统一采用该术语与 UI 文案。  
- **写入前再确认：** 在实际修改文件之前，用要点形式告知用户「准备写入哪些章节 / 什么内容」，得到确认后再动手。
- **保持文档结构稳定：**
  - 不随意改变原有大纲结构与标题层级；
  - 新增内容应放在最合适的小节下，或在必要时新增小节并说明原因；
  - 保证语言风格与现有文档一致，便于日后查阅和 diff。

> 若用户只想讨论而暂不希望更新文档，AI 应仅输出建议文案或大纲，不修改任何文件。

---

### 8.4 第三步：加入 tasks.md 与 dev-log.md

当用户确认规格文档中的描述没有问题，并提出类似指令（如：「文档没问题，请加入 tasks 和 dev log」）时，AI 才能更新任务列表与开发日志。

AI 需要分两部分执行：

#### 8.4.1 更新任务列表（tasks.md）

更新 `docs/tasks.md` 时，AI 必须遵守以下规则：

- **判断优先级再插入：**
  若用户未说明优先级，AI 必须先确认优先级，并提出建议。
  - 若是核心功能： 插入在「已完成任务之后、所有未完成任务之前」；
  - 如有必要，可以为该功能单独新增一个父任务（例如 `### 5.0 新功能名称`）。
  - 非核心功能： 插入在当前未开始的任务之后
  - 低优先级： 放在任务列表尾部
    只有用户确认后才可写入任务列表。s
- **自动维护编号：**
  - 确保所有父任务与子任务编号连续、格式统一（`1.0` / `1.1` / `1.2` 等）；
  - 如需重排任务顺序，允许为此目的调整编号。
- **不得篡改既有任务含义：**
  - 不修改已有任务的实际含义和范围（除非用户明确要求重写任务）；
  - 如发现旧任务与新规格冲突，应先在对话中指出，并在用户确认后同步更新任务与规格。
- **任务描述可执行：**
  - 使用动词开头（例如：Implement / Add / Update / Refactor / Document）；
  - 对应到 `spec.md` / `style.md` 中的具体条目，必要时在描述中引用相关章节或文件路径。

#### 8.4.2 更新开发日志（dev-log.md）

- 按「7.2 开发者日记（docs/dev-log.md）」的规则更新 `docs/dev-log.md`：
  - 在最新日期下对应的分类小节中（例如 `新功能 (Feature)` / `文档 (Docs)`）追加本次变更说明；
  - 简要描述：改了什么、为什么改、参考了哪些文档（如 `spec.md` 的某一小节）；
  - 只追加，不修改历史内容。

---

### 8.5 禁止事项

在整个「添加新功能」流程中，AI 不得：

- 跳过大纲与讨论流程，直接写代码或改文档；
- 未经用户确认擅自写入或修改 `spec.md` / `style.md` / `tech.md` / `tasks.md` / `dev-log.md`；
- 改写历史开发日志条目，只能用新条目补充说明；
- 修改已有任务的实际含义（除调整编号或经用户明确同意的重写）；
- 在 dev-log 中堆砌不必要的低价值技术细节（例如内部实现微调但对外行为无变化）；
- 混淆 `spec.md` / `style.md` / `tech.md` 的职责范围，把行为逻辑写进样式文档，或把视觉细节写进技术文档。

---

## 9. 语言使用规范

本节约定本项目中中英文的使用范围，避免文档与代码语言混杂。

### 9.1 中文使用范围（内部沟通）

- `spec.md`、`style.md`、`content.md`、`tech.md`、`tasks.md` 等内部项目说明文档；
- 团队内部沟通记录（如设计评审纪要、需求讨论结论）；
- 项目管理文档（看板说明、迭代计划等）；
- 内部会议纪要与决策记录。

### 9.2 英文使用范围（所有对外与代码相关内容）

**代码层面：**

- 所有代码注释使用英文；
- 变量名、函数名、类名、文件名使用英文；
- 开发文档（如 README、API 说明等对开发者开放文档）使用英文；
- 测试数据、示例数据使用英文；
- API 文档、接口返回字段说明使用英文。

**网站内容：**

- 所有面向终端用户的界面文字使用英文；
- 按钮、标题、副标题、说明文字使用英文；
- 错误提示与校验信息使用英文；
- 帮助文档、内嵌教程、FAQ 使用英文；
- 用户注册 / 登录、设置页面等对外表单界面使用英文。

**部署与运维相关：**

- 服务器与环境配置（如环境变量名、配置文件键名）使用英文；
- 域名、路径前缀等对外标识使用英文；
- 数据库设计（表名、字段名）使用英文；
- 日志记录、监控报警消息使用英文。

> 说明：如遇特殊业务需要使用其他语言（例如需要多语言支持），应在 `spec.md` 中单独说明，并在实现中通过 i18n 机制处理，而不是直接在代码或模板中混写多种语言。

---

**总结：**  
`rules.md` 规定了 AI 协作的「元规则」——如何读文档、如何问问题、如何决定输出结构、如何协调 `spec.md` / `style.md` / `content.md` / `tech.md` / `tasks.md`、以及如何提交代码与记录开发日志。  
在此基础上，`create-prd.md`、`generate-tasks.md`、`design-style.md`、`establish_content.md` 和 `finalize_tech.md` 等文件只负责各自领域的具体模板与结构，不再重复这些协作层面的约定。
