# FocusSearch Chrome Extension - PRD

文档角色说明：本文件定义「做什么、怎么运作」——功能逻辑、交互流程与业务规则；具体颜色/字体/间距/组件样式等视觉细节统一收敛在 `docs/style.md`。

语言使用规范：本项目内部规格文档（如 `spec.md` / `style.md` / `tasks.md` 等）使用中文撰写，所有代码（变量名、函数名、注释）、对外界面文案与配置统一使用英文；完整说明参见 `docs/rules.md` 中的「语言使用规范」一节。

在本地查看效果：优先使用 `pnpm dev` 启动开发服务器；如未安装 pnpm，可参考项目 README 使用 npm 或 yarn 等命令。

## 1. Introduction / Overview

FocusSearch 是一款面向高频搜索与深度阅读用户的 Chrome / Chromium 浏览器扩展，用于：

减少阅读过程中的无意跳转（误点链接）
将「选中文本 → 搜索」压缩到最短路径
提供一个统一、可定制的搜索入口（多搜索引擎）
核心能力：

链接仍保持可视样式，但在指定场景下不可点击（可配白名单域名）
在普通模式下，选中文字会出现可配置的搜索气泡菜单
在搜索模式下，选中文字自动使用默认搜索引擎后台搜索，无需额外点击
目标读者为初级前端开发者，假设对 Chrome 扩展基础概念（manifest、content script、background 等）有初步了解。

## 2. Goals

- 在用户阅读或做笔记时，显著减少由误点链接引发的页面跳转中断。
- 将「看到一个概念 → 发起搜索」的操作步骤压缩为 0–1 次点击。
- 允许用户自定义和管理搜索引擎列表（新增 / 删除 / 排序），使工具适应用户的搜索习惯。
- 支持在不同阅读强度场景下快速切换：普通模式（气泡菜单）与搜索模式（自动搜索）。
- 在 Chrome 及其它 Chromium 内核浏览器中保持一致、稳定的行为。

## 3. User Stories

- 作为一名阅读长文和做笔记的用户，我希望在当前站点临时禁用链接点击，这样即使误点链接也不会跳走页面，从而保持阅读连贯。
- 作为一名查阅英文资料的用户，我希望选中一个术语时能立即在 Google / YouTube / Reddit 发起搜索，而不需要复制、切换标签、粘贴。
- 作为一名进行密集调研的用户，我希望在「搜索模式」下只要选中文字就自动使用默认搜索引擎进行搜索，而不需要额外点击按钮，从而在短时间内查很多概念。
- 作为一名重度搜索用户，我希望可以自定义搜索引擎（名称、URL 模板、顺序），包括添加新的引擎和删除不常用的引擎，以便贴合自己的工作流。
- 作为一名有固定常用站点的用户，我希望将一些站点加入白名单，这样在这些站点上链接保持可点击，不受链接禁用功能影响。
- 作为一名需要频繁切换模式的用户，我希望有快捷键（默认 Alt+S）和简单的弹出层开关来切换「搜索模式」和控制当前站点的链接禁用状态。

## 4. Interaction Flows（交互路径）

本节从用户视角串联典型使用场景，描述「用户做什么 → 系统如何响应」，便于设计与开发在实现时对齐整体体验。下述路径是功能需求的补充，而非重复。

### 4.1 阅读 + 链接禁用（Link Guard）

1. 用户在任意网页正常阅读，默认情况下扩展不干预链接行为（Link Guard 关闭）。
2. 用户发现当前站点容易误点链接，于是点击浏览器工具栏中的 FocusSearch 图标打开 Popup。
3. 在 Popup 中看到当前站点的「Disable links on this site」开关，用户将其打开，当前站点进入链接禁用模式。
4. 之后用户在该站点点击页面中的链接时，不再触发页面跳转、新标签或新窗口；如需访问链接，可暂时关闭 Link Guard，或在白名单中配置此站点。
5. 用户再次打开 Popup，可以看到当前站点 Link Guard 的状态，并可随时关闭。

### 4.2 阅读 + 气泡搜索（普通模式）

1. 用户在普通模式下阅读网页（Search Mode 关闭），Link Guard 可开可关。
2. 用户在页面中选中一段文本（去除首尾空白后的长度 > 0），系统在选区附近显示浮动的搜索气泡菜单，展示当前配置的搜索引擎列表。
3. 用户点击气泡中的某个搜索引擎（如 Google），系统在后台打开一个新的搜索结果标签页，当前阅读页面保持不变，不自动切换到新标签。
4. 用户点击页面其他区域或取消选中时，气泡菜单自动隐藏。

### 4.3 阅读 + 搜索模式（Search Mode）

1. 用户进入密集调研阶段，希望「选中即搜」：通过 Popup 中的搜索模式开关，或按下全局快捷键 `Alt+S`，开启 Search Mode，此时 Popup 中应清晰显示 Search Mode 已开启。
2. 在 Search Mode 开启状态下，用户在页面中选中文本：不再显示气泡菜单，系统自动使用当前默认搜索引擎在后台打开搜索结果标签页；如果选区为空或仅包含空白，则不触发搜索。
3. 用户查询一轮后，可以：
   - 再次通过 Popup 开关或快捷键 `Alt+S` 关闭 Search Mode；
   - Popup 中 Search Mode 状态同步为 `Off`，恢复普通模式行为。

### 4.4 管理搜索引擎列表（Options Page）

1. 用户在 Popup 中点击「Open Settings」或从扩展管理页打开 Options 设置页。
2. 用户在 Options 页的「Search engines」区块中，可以查看搜索引擎列表、拖拽调整顺序、通过表单新增或删除搜索引擎。
3. 用户在列表中选择一个「默认搜索引擎」，后续在 Search Mode 和气泡菜单中都会以此默认项优先展示或高亮。
4. 用户保存或离开设置页后，后续 Popup 和页面内搜索行为都应基于最新的搜索引擎配置工作。

### 4.5 管理白名单域名

1. 用户在 Options 页切换到「Domain whitelist」区块。
2. 用户通过输入框新增白名单域名（例如仅输入主域名 `example.com`），保存后，该域名以及其子域名（`www.example.com`、`sub.example.com` 等）在后续访问时均视为白名单。
3. 对于列表中的域名，用户可以：
   - 删除不再需要的白名单项；
   - 查看当前白名单列表。
4. 当用户访问白名单中域名对应的页面时，即使该域名在 Link Guard 中被设置为开启，页面中的链接仍保持正常可点击（白名单优先级更高）。

### 4.6 首次使用与模式切换

1. 用户安装扩展后首次打开 Popup：
   - 默认 Search Mode 为关闭；
   - Link Guard 默认对所有站点关闭。
2. 用户可以：
   - 在 Popup 中为当前站点开启 Link Guard；
   - 开启 / 关闭 Search Mode，观察 Popup 中状态指示变化。
3. 后续用户在任意页使用快捷键 `Alt+S` 切换 Search Mode 时，当前页面和之后新打开的页面都应按照最新模式来决定是显示气泡菜单还是直接发起搜索。

---

## 5. Functional Requirements

### 5.1 链接禁用（Link Guard）

- **功能描述**
  - 提供一个「链接禁用」功能，可按站点启用。
  - 当在某站点启用后，页面中所有标准超链接元素（`<a>`，含常见嵌套结构中的点击）依然保持原有颜色与下划线样式，但点击不会触发跳转。
- **禁用效果**
  - 用户点击这些链接时，不会触发导航：
    - 不跳转当前页。
    - 不打开新标签。
    - 不弹出新窗口。
- **默认行为与站点级配置**
  - 默认情况下，全局不开启链接禁用。
  - 用户可以通过扩展图标的弹出层（popup）为「当前站点」开启或关闭链接禁用。
  - 开关以「域名级」保存（例如 `example.com`），同一域名下的所有页面复用该设置。
- **白名单机制**
  - 用户在设置页中可输入主域名（如 `zhihu.com`）。
  - 白名单匹配规则：输入 `example.com` 时，以下场景均视为白名单匹配：
    - `example.com`
    - `www.example.com`
    - `sub.example.com`
    - `example.com/any/path`
  - 当当前页面域名属于白名单时，即使该域名被配置为启用链接禁用，仍然不会禁用链接点击（白名单优先级高于禁用设置）。
- **实现要求**
  - 使用 content script 注入页面，监听链接点击事件。
  - 必须防止常见的点击方式触发导航，包括：
    - 左键点击。
    - 鼠标中键（新标签）。
    - `Ctrl/Command + 点击`。
  - 右键菜单「在新标签中打开」可视为非自然误点，可保留。
  - 对于需要被禁用的点击，调用 `event.preventDefault()` 和 `event.stopPropagation()` 拦截默认导航行为。
- **反馈设置**
  - 在链接被禁用时，为了避免完全无反馈，可在可选设置中支持一个轻量反馈选项（例如：短暂显示 toast 或控制台日志），默认关闭。

### 5.2 文本选中气泡搜索菜单（普通模式）

- **模式说明**
  - 系统必须提供「普通模式」：当搜索模式关闭时生效。
- **触发与展示**
  - 在普通模式下，当用户在页面中选中非空文本（长度 > 0 且去除首尾空白后仍有内容）时：
    - 在选区附近（通常为选区下方、视口内可见位置）显示一个浮动的「搜索气泡菜单」。
  - 气泡菜单内容为当前配置的搜索引擎列表（按排序展示）。
- **行为**
  - 点击气泡菜单中的任一搜索引擎项时：
    - 使用该搜索引擎的 URL 模板，将 `{query}` 替换为当前选中的文本（进行 URL 编码）。
    - 在后台打开一个新标签页发起搜索（例如：`chrome.tabs.create({ url, active: false })` 或等效方式）。
    - 当前阅读页面不切换、不失焦。
  - 当用户点击页面其他位置或取消选中时，气泡菜单自动隐藏。
- **超长选区处理**
  - 系统应对过长的选中文本做处理：
    - 可配置或固定一个最大长度阈值（例如 2000 字符），超过部分截断。
    - 超长文本搜索行为的具体策略可在实现时细化，如不确定可列入「开放问题」。
- **开关设置**
  - 用户可以在设置页中启用/禁用「选中文字气泡搜索菜单」功能（仅在普通模式下生效）。

### 5.3 搜索模式（自动搜索）

- **模式概念**
  - 系统必须提供「搜索模式」的概念（Search Mode）。
  - 搜索模式为全局状态，默认关闭。
- **开启与关闭方式**
  - 用户可以通过以下方式开启或关闭搜索模式：
    - 快捷键（默认 `Alt+S`）。
    - 扩展弹出层（popup）中的开关。
- **行为**
  - 当搜索模式开启时：
    - 选中文本 **不会** 显示气泡菜单。
    - 选中文本后，会自动使用当前默认搜索引擎发起搜索：
      - 构造 URL：将默认搜索引擎的 URL 模板中的 `{query}` 替换为选中文本。
      - 在后台打开新标签页，不切换当前阅读页面。
  - 在搜索模式下，如果选区为空或仅包含空白字符，则不触发搜索。
- **状态展示与快捷键说明**
  - 搜索模式的当前状态必须在弹出层中清晰展示（例如：`Search Mode: On/Off`）。
  - 搜索模式默认快捷键为 `Alt+S`，系统应在设置页或文案中说明用户可以在 Chrome 的扩展键盘快捷键设置界面进行自定义。

### 5.4 搜索引擎配置

- **搜索引擎列表结构**
  - 系统必须维护一个可配置的「搜索引擎列表」，每个搜索引擎包含：
    - 名称（英文，例如 Google、YouTube、Reddit）。
    - URL 模板（包含 `{query}` 占位符，例如：
      - `https://www.google.com/search?q={query}`
      - `https://www.youtube.com/results?search_query={query}`
      - `https://www.reddit.com/search?q={query}`）。
- **默认内置项**
  - 首发版本中，默认内置以下搜索引擎：
    - Google
    - YouTube
    - Reddit
- **管理操作**
  - 用户可以在设置页中执行以下操作：
    - 新增搜索引擎：输入名称和 URL 模板（必须包含 `{query}` 且为合法的 `http/https` URL）。
    - 删除已有搜索引擎（需防止删除后列表为空，至少保留一个条目）。
    - 通过拖拽排序调整搜索引擎的显示顺序。
- **默认搜索引擎**
  - 系统必须允许用户指定一个「默认搜索引擎」：
    - 默认搜索引擎用于搜索模式下的自动搜索。
    - 也可用于普通模式中气泡菜单的第一个（或高亮）条目。
- **数据存储**
  - 搜索引擎列表及其默认项必须持久化存储，通过 `chrome.storage` 实现（建议使用 `chrome.storage.sync`）。

### 5.5 白名单域名配置

- **管理界面**
  - 系统必须提供白名单域名管理界面（在设置页）。
  - 用户可以新增、删除白名单域名。
- **输入与匹配规则**
  - 输入规则：只需输入主域名（如 `example.com`），不需要协议和路径。
  - 匹配规则：
    - 当当前页面的有效域名为 `example.com` 或其任一子域名（如 `www.example.com`、`sub.example.com`）时，视为命中白名单。
    - 该规则应与用户对「整站白名单」的直观认知保持一致。
- **优先级**
  - 白名单对链接禁用的优先级：
    - 当某域名在白名单中时，无论「链接禁用」功能对该域名的开关状态为何，该域名上的链接都保持正常可点击。

### 5.6 弹出层（Popup）与设置页（Options Page）

- **弹出层（Popup）**
  - 系统必须在点击扩展图标时弹出一个轻量级的弹出层（popup），用于快速控制：
    - 当前站点的「链接禁用」开关：
      - 文案示例：`Disable links on this site`（勾选/开关）。
    - 全局搜索模式开关状态：
      - 文案示例：`Search Mode: On/Off`，并可点击切换。
    - 打开完整设置页的入口：
      - 按钮示例：`Open Settings`。
- **设置页（Options Page）**
  - 系统必须提供一个独立的设置页（Chrome 扩展「选项页」），包含：
    - 搜索引擎列表管理 UI（新增/删除/拖拽排序、默认引擎选择）。
    - 白名单域名管理 UI（列表 + 新增/删除）。
    - 功能行为设置：
      - 是否开启「选中文字气泡搜索菜单」功能（普通模式下）。
      - 是否在链接被禁用点击时给出轻量反馈（例如 console 或 toast）。
    - 使用说明或简要帮助（包括如何在 Chrome 中修改快捷键）。

### 5.7 快捷键与交互行为

- 系统必须支持一个全局快捷键用于切换搜索模式：
  - 默认指定为 `Alt+S`（在 manifest 中仅提供默认建议，实际生效可由用户在浏览器中调整）。
- 当用户通过快捷键或弹出层切换搜索模式时：
  - 弹出层 UI 的搜索模式状态需同步更新。
  - 不需要刷新当前页面即可使新的模式生效（即内容脚本应对模式变化有响应机制）。

### 5.8 数据存储与同步

- 系统必须使用 `chrome.storage` 存储以下信息：
  - 搜索引擎列表及默认搜索引擎。
  - 白名单域名列表。
  - 每个域名的「链接禁用」开关状态。
  - 全局搜索模式开启/关闭状态。
  - 功能行为设置（气泡启用、反馈开关等）。
- 在无特殊限制时，优先使用 `chrome.storage.sync`，使用户在登录同一账号的多台设备上获得一致体验；若存在容量或性能问题，可以改为 `chrome.storage.local`，并在文档中说明取舍。

## 6. Non-Goals（非目标 / 范围外）

- 本版本不提供对网页内容的深度改写，如阅读模式（去广告、重排版）。
- 不对搜索结果页面进行任何 UI 或逻辑层面的改造，只负责构造搜索 URL 并打开。
- 不实现复杂的分析或推荐功能（例如推荐搜索词、自动翻译等）。
- 不记录或上传用户的具体选中内容、搜索关键词等隐私数据（除非未来明确扩展并更新隐私策略）。
- 不支持非 Chromium 浏览器（如 Firefox、Safari）的适配和维护（可在未来版本单独规划）。

## 7. Design Considerations（设计考虑）

**视觉风格**

- 气泡菜单：简洁、轻量，不遮挡主要阅读区域。
- 使用英文文案（例如：Search, Search Mode, Disable links on this site 等），与 1A 选择一致。

**交互优先级**

- 选中文本时，优先保证原生行为（浏览器默认选中、复制等）正常，插件行为在其之上「附加」，而非替代。
- 气泡菜单和搜索模式触发行为要有清晰区分：普通模式：选中 → 气泡 → 点引擎；搜索模式：选中 → 自动搜索，无气泡。

**可用性细节**

- 气泡菜单的位置应尽量避免遮挡选中文本。
- 当视口空间不足时（例如选区在底部），气泡可在上方显示或做简单位置调整。
- 弹出层和设置页文案需简洁明了，便于理解功能开关的作用。

## 8. Technical Considerations（技术实现考虑）

**浏览器与 Manifest 版本**

- 目标支持：Chrome 及其他 Chromium 内核浏览器（如 Edge、Brave 等）。
- 建议使用 Manifest V3。
- 使用 service_worker 作为后台脚本。
- 使用 scripting API 注入 content script。

**权限**

- 可能需要的权限包括（根据最终实现精简）：
- tabs：用于创建后台标签。
- storage：用于存储配置。
- scripting / activeTab：用于向页面注入脚本。
- 必要的 host 权限（可考虑 `<all_urls>` 或在 manifest 中使用可选主机权限机制）。

**内容脚本与背景脚本通信**

- 背景脚本负责维护全局设置状态，并接收来自内容脚本的搜索请求，创建后台标签。
- 内容脚本负责监听选中文本事件（mouseup、selectionchange 等）、生成并展示/隐藏气泡菜单，以及在链接禁用启用时拦截链接点击事件。

**性能与兼容性**

- 内容脚本逻辑需要尽量轻量，避免在滚动、鼠标移动等高频事件上做重计算。
- 尽量减少对网页 DOM 的侵入性修改，只添加必需的 DOM 节点（气泡容器）和事件监听。
- 对于框架页面（例如 SPA 或使用虚拟 DOM 的站点），应考虑链接或选区区域动态变化的情况。

## 9. Success Metrics（成功标准）

- 在不收集隐私数据前提下，定量指标难以精确统计，这里给出目标方向：
- 在典型用户的阅读场景中，误点链接导致的页面跳转次数显著下降（通过用户主观反馈衡量）。
- 用户在使用插件后，进行「选中即搜」的次数明显增加，复制/粘贴到搜索框的操作频率下降。
- 至少有 80% 的活跃用户自定义或调整过搜索引擎列表或白名单域名，说明配置能力被实际使用。
- 扩展在主流 Chromium 浏览器中运行稳定，无明显性能问题或崩溃报告。

## 10. Open Questions（开放问题）

- 选区变化触发频率：当用户慢慢拖动选区时，是在选区稳定后一定时间（例如 300ms）再触发自动搜索/显示气泡，还是每次变化都重新计算？
- 超长选区处理策略：超过阈值的选区是直接截断，还是提示用户选区过长不触发搜索？
- 非 `<a>` 元素的「伪链接」：对于使用 onclick 或自定义组件实现的伪链接，是否也应该禁用？实现成本和兼容性如何平衡？
- 不同浏览器中的快捷键行为：各个 Chromium 浏览器对默认快捷键的支持和冲突情况如何？是否需要提供额外的引导或默认关闭快捷键？
- 未来扩展：是否考虑在未来版本支持更多浏览器（Firefox、Safari），以及是否需要抽象出通用逻辑层以复用？
- 如果你愿意，下一步我可以基于这个 PRD，帮你拆成开发任务列表（manifest 结构、content script 事件处理、popup/option 页面组件等）。

### 11. 补充说明

**本地完工提示（可选）**

- 当本 PRD 对应的全部开发任务在本地完成后，如需声音提醒，可参见 `docs/rules.md` 中的「本地完工提示」命令，在终端手动运行。
